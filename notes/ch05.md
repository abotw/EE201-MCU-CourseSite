---
title: Ch05
layout: page
parent: Notes
---

# Chapter 5: Timers and Digital Tube Basics
{:.no_toc}

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

## 5.1 Logic Operations and Logic Circuits

This section introduces the fundamental operators used in C language for microcontrollers:

- **Logical Operators (`&&`, `||`, `!`)**: Operate on the Boolean (true/false) value of entire expressions, mainly used for program flow control (e.g., `if`, `while`) 1. They feature "short-circuiting" where the second operand may not be evaluated 2.
- **Bitwise Operators (`&`, `|`, `~`, `^`)**: Operate directly on the individual binary bits of a variable 3.
    - **Bitwise AND (`&`)**: Acts as a **filter** for **clearing** or **extracting** specific bits 4.
	    - 清零
	    - 提取
    - **Bitwise OR (`|`)**: Acts as a **setter** for setting or turning on specific bits 5.
    - **Bitwise Shift Operators (`<<`, `>>`)**: **Left Shift (`<<`)** is equivalent to multiplying by $2^n$ (e.g., `x << 2` is $x * 4$) 6. **Right Shift (`>>`)** is equivalent to dividing by $2^n$ 7. These are highly efficient.
- **Hardware Register Control**: Bitwise operations are essential for controlling hardware registers:
    - **Setting a bit**: Use bitwise OR: `PORTx |= (1 << n);` 8.
    - **Clearing a bit**: Use **bitwise AND** with a negation: `PORTx &= ~(1 << n);` 9.

## 5.2 Timers and Counters

This section details the 8051 microcontroller's timing module:

- **Timing Units**:
    - **Clock Cycle (T)**: The smallest time unit, $T = 1 / \text{Crystal Frequency}$ 10.
    - **Machine Cycle**: The shortest time to complete one operation. For a standard 8051, **1 Machine Cycle = 12 Clock Cycles** 11.
- **Timer/Counter Module**: It is a single internal module that can be configured for either timing (based on machine cycles) or counting (based on external pulses) 12.
- **Key Registers**:
    - **THx / TLx**: A pair of 8-bit registers (High/Low) that store the **16-bit count value** 13.
    - **TMOD (Timer Mode Register)**: Configures the timer's working mode and behavior (e.g., Timer/Counter selection, Gate control) 14.
    - **TCON (Timer Control Register)**: Controls the timer's operation and monitors its status. Key bits are:
        - **TRx**: **Run Control Bit** (set to 1 to start, 0 to stop) 15.
        - **TFx**: **Overflow Flag** (set to 1 by hardware when the timer overflows) 16.
- **Working Modes**:
    - **Mode 1 (16-bit Timer)**: The most commonly used mode, counting from 0 to 65535 17.
    - **Mode 2 (8-bit Auto-Reload)**: Suitable for fixed-period timing; TLx overflows and is automatically reloaded with the value stored in THx 18.
- **Usage Steps**: 1. Set **TMOD** (Mode) $\rightarrow$ 2. Set initial values in **THx/TLx** $\rightarrow$ 3. Start timer (**TRx=1**) $\rightarrow$ 4. Monitor **TFx** (Overflow) 19.

## 5.3 Implementing LED Blinking with a Timer

Using a timer for delay is superior to using a simple `for` loop because it is **precise**, **stable**, and **non-blocking** (CPU can perform other tasks) 20.

- **Initial Value Calculation**: To achieve a specific time delay, the initial count value $Y$ is calculated:
    - $X = \text{Desired Time} / \text{Machine Cycle Time}$ (required machine cycles) 21.
    - $Y = 65536 - X$ (initial value to load into THx/TLx) 22.

## 5.4 & 5.5 Digital Tube (Seven-Segment Display) Basics and Static Display

- **Structure**: A digital tube is composed of 8 individual LEDs (a-g, and dp for the decimal point) 23.
- **Types**:
    - **Common Anode**: The common pin (COM) is connected to a high potential (+VCC). A segment is lit by applying a **low level (0)** to its cathode 24.
    - **Common Cathode**: The common pin (COM) is connected to a low potential (GND). A segment is lit by applying a **high level (1)** to its anode 25.
- **Static Display**: Only one digital tube is lit at a time 26. It requires two types of control:
    - **Segment Selection (P0 Port)**: The P0 port determines which segments (a-g, dp) are lit to form the digit (e.g., to display "1", segments b and c are lit) 27.
    - **Bit Selection (74HC138 Decoder)**: A decoder (like the 74HC138) is used to select and enable which specific digital tube in a multi-digit display is currently active 28.
- **`code` Keyword**: Used in C to store constant data, such as the segment display codes (truth table), into **Flash (Program Storage Space)** instead of the limited **RAM (Random Access Memory)**.

---

## Exam Points for Final Exam

Focus on understanding and being able to apply the following core concepts:

### I. Logic & Bitwise Operations

- **Bit Manipulation**: Know the exact C code for:
    - **Setting/Enabling** a specific bit (e.g., `PORTx |= (1 << n);`) 29.
    - **Clearing/Disabling** a specific bit (e.g., `PORTx &= ~(1 << n);`) 30.
- **Shift Operators**: Understand that $x \ll n$ is multiplication by $2^n$ and $x \gg n$ is division by $2^n$ 31.
- **Operator Comparison**: Clearly distinguish between **Logical Operators** (Boolean, flow control, short-circuit) and **Bitwise Operators** (Bit-level, hardware control, no short-circuit) 32.

### II. Timers and Counters

- **Machine Cycle**: Know the definition and that **1 Machine Cycle = 12 Clock Cycles** for a standard 8051 33.
- **Key Registers and Bits**:
    - **TMOD**: Configures the timer's mode (Mode 1, Mode 2) and function (Timer or Counter) 34.
    - **TCON**: Specifically, the function of **TRx** (Start/Stop) and **TFx** (Overflow Flag) 35.
- **Timer Modes**: Know the use case for **Mode 1 (16-bit)** (most common) and **Mode 2 (8-bit Auto-Reload)** (fixed period timing) 36.
- **Timer Calculation**: Be able to calculate the required **Initial Value (THx/TLx)** for a given time delay 37.
- **Usage Steps**: Memorize the four mandatory steps for initializing and using a timer 38.

### III. Digital Tubes and Memory

- **Digital Tube Types**: Be able to differentiate and explain how to light a segment for **Common Anode** (low level/0 required) vs. **Common Cathode** (high level/1 required) displays 39.
- **Static Display Control**: Understand the roles of **Segment Selection** (P0 port for digit data) and **Bit Selection** (74HC138 decoder for enabling the specific tube) 40.
- **`code` Keyword**: Understand its purpose: to store read-only constant data (like display segment codes) in **Flash** memory to conserve limited **RAM**.
