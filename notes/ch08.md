---
title: Ch08
layout: page
parent: Notes
---

# Chapter 8: Advanced Functions and Keypads
{:.no_toc}

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

## 8.1 Microcontroller Minimum System Details

- **Power System:** Microcontrollers (MCUs) must operate within a specific voltage range (e.g., **5V MCUs**: 3.4V to 5.5V; **3.3V MCUs**: 2.7V to 3.6V) 1. Operation outside this range will stop the MCU (too low) or damage it (too high) 2.
- **Crystal Oscillator:** This is the "heart" of the MCU, providing the clock signal that dictates the program's execution timing 3.
    - **Passive Crystal (2 pins):** Requires the MCU's internal oscillator circuit. It is low cost and widely used 4.
    - **Active Oscillator (4 pins):** Contains an internal oscillation chip, allowing it to work independently. It is generally higher cost and higher precision 5. 
    * **Reset Circuit:** Its function is to ensure a reliable startup upon power-on and return the MCU to a known initial state if the program crashes 6.
    - **Power-on Reset:** The capacitor-resistor (RC) circuit holds the **RESET pin High** momentarily during charging, then it restores to **Low** level to start the MCU 7.
    - **Reset Time ($t$):** The required time is determined by the formula $t \approx 1.2 \times R \times C$ and must be at least two machine cycles (e.g., $\ge 2\mu s$ for a 51 MCU) 8.
- **Capacitors:** They act as an **open circuit** to steady-state DC, but they can pass AC. They have a low impedance (low capacitive reactance $X_C$) for **high-frequency** signals and high impedance for low-frequency signals 9.

## 8.2 Function Calls

- **Purpose:** Functions divide a program into modular blocks, improving **code readability, reusability**, and preventing redundant code 10.
- **Structure:** A program has a single **`main` function**, which is the unique entry point 11. Other functions can be called by `main` or by each other, but **`main` cannot be called** by any other function 12.
- **Parameters:**
    - **Actual Parameters (Arguments):** The specific data passed during the function call 13.
    - **Formal Parameters (Parameters):** The temporary variables defined in the function to receive the data 14.
    - **Transfer Rule:** Data is passed **single-direction** (Actual $\rightarrow$ Formal). Changes to the formal parameters do not affect the original actual parameter values 15.
- **Declaration & Definition:** A function must be declared (prototyped) or defined before it can be called 16.
- **`static` Variables:** The `static` keyword ensures that a variable's value is **retained** between multiple function calls (e.g., for counters or index tracking) 17.

## 8.3 Keypad Fundamentals

- **Role:** Keypads (buttons) are essential input devices 18.
- **Types:** **Independent Keypads** (one pin per key) and **Matrix Keypads** 19.
- **Independent Keypad Principle (with Pull-up Resistor):**
    - **Pressed:** The I/O pin reads a **Low Level** (close to 0V) 20.
    - **Released:** The I/O pin reads a **High Level** (pulled up to +5V) 21.
- **I/O Port Reading:** To read an external signal (like a key press), the MCU I/O port must be configured to output a **High Level (1)**, which puts the port into a high-impedance state for external sensing 22.

## 8.4 Keypad Scanning and Debouncing

- **Keypad Debouncing:** Mechanical key presses cause unstable electrical contact (bounce) for **5-20ms**. The MCU must wait for this period to ensure a single, confirmed key event 23.
- **Software Debouncing Issue:** Using a simple `delay()` function to wait out the bounce is a **blocking delay** that pauses the entire program, potentially causing the MCU to miss other events 24.
- **Solution:** Use **non-blocking methods** like **Timer Interrupts** or **State Machines** to handle timing without pausing the main loop 25.

## 8.5 & 8.6 Practical Keypad Debouncing and Matrix Keypads

- **Timer Interrupt Debouncing:** The core practical method is to use a timer interrupt (e.g., every 1-2ms) to scan the key. By storing multiple consecutive scans in a buffer (e.g., using bit-shifting), the software can check for a stable state (e.g., 8 consecutive scans of the same value) to confirm the key state is stable after the 16ms bounce period 26.
- **Matrix Keypad Scanning:** This method uses a grid (e.g., $4 \times 4$) to enable **I/O port reuse** (e.g., 8 pins for 16 keys) 27.
    - **Scan Process:** The MCU sequentially sets one **Row Output** (`Kout`) to **Low** and checks all **Column Inputs** (`Kin`). If a column reads Low, the key at the intersection is pressed 28.

## 8.7 Simple Addition Calculator

- This section demonstrates a complete application using the matrix keypad and interrupt debouncing to implement a calculator interface on a seven-segment display 29.
- **Key Logic (`KeyAction`):**
    - **Number Input:** New digits are incorporated by multiplying the current number by 10 and adding the new digit (`addend = (addend*10) + new_digit`) 30.
    - **Addition/Enter:** Adds the `addend` to the `result` and resets `addend` 31.
    - **ESC:** Clears both `result` and `addend` to 0 32.
    - **Display (`ShowNumber`):** Implements **high-bit blanking** to hide leading zeros on the display for cleaner output 33.

---

## Exam Points for Final Exam

The most critical concepts and comparisons are:

### Core Concepts and Principles

- **MCU Voltage:** The specified operating voltage range and the effects of operating outside this range 34.
- **Crystal Oscillator Function:** Its role as the timing "heart" of the MCU 35.
- **Reset Circuit Function:** Ensuring program startup and recovery from crashes ("program runaway") 36.
- **Capacitor Behavior:** How a capacitor acts on **DC** (blocking in steady-state) vs. **AC** (conducting, especially high frequency) 37.
- **Function Role:** Modularity, reusability, and code structure 38.
- **Keypad Debouncing:** The phenomenon of electrical bounce ($\approx 5-20$ms) and the necessity of waiting for a stable state 39.

### Key Distinctions and Comparisons

- **Active vs. Passive Crystal:** Know the differences in structure (pins), required external components, and application (general vs. special) 40.
- **Formal vs. Actual Parameters:** Be able to define each and explain the **single-direction** data transfer rule 41.
- **Independent vs. Matrix Keypad:** Understand that matrix keypads are primarily used to achieve **I/O port reuse** to detect more keys with fewer pins 42.
- **Blocking vs. Non-blocking Delay:** Understand the drawback of the `delay()` function (blocks all operations) and why **Timer Interrupts** are preferred for debouncing 43.

### Code and Circuit Details

- **Reset Time Formula:** The simplified calculation $t \approx 1.2 \times R \times C$ 44.
- **`static` Keyword:** Its purpose in functions is to ensure variables retain their value across calls 45.
- **I/O Port Configuration for Key Reading:** The I/O port must be set to output **High Level (1)** to allow external key status to be read 46.
- **Matrix Scanning Logic:** The sequence of setting one **row low** and checking for a **low column** 47.
- **Calculator Input Logic:** The mathematical principle for decimal input: `new_value = old_value * 10 + digit` 48.