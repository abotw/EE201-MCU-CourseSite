---
title: Ch04
layout: page
parent: Notes
---

# Chapter 4: C Language Fundamentals and the Implementation of a Running Light
{:.no_toc}

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

## 4.1 C Language Variables and Operators

| **Concept**                   | **Key Points for Exam**                                                                                                                                                                                                                                                                    |
| ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Microcontroller Resources** | Be able to name the **three major internal resources** of a microcontroller: **FLASH** (Program Storage/ROM), **RAM** (Memory), and **SFR** (Special Function Registers) 1.                                                                                                                |
| **Number Systems**            | Understand the three core bases in computing 2: 1. **Decimal** (Base 10) 3. 2. **Binary** (Base 2: 0 and 1, the computer's foundation) 4. 3. **Hexadecimal** (Base 16: 0-9, A-F, a shorthand for binary) 5. You should be able to perform simple conversions (e.g., decimal 4 is 0b100) 6. |
| **Variables & Constants**     | **Constant**: A fixed value in the program 7. **Variable**: A symbol whose value can change during execution 8.                                                                                                                                                                            |
| **Data Types (C51)**          | Memorize the basic data types and their size/range 9:<br><br>• `char`: 1 byte (e.g., `unsigned char` range is 0 to 255)  10.<br>• `int`: 2 bytes (e.g., `unsigned int` range is 0 to 65535)  11.<br>• Understand the concept and potential consequences of **variable overflow** 12.       |
| **Arithmetic Operators**      | Know the operators: `+`, `-`, `*`, `/`, and the **Modulo** (`%`) operator 13.<br><br>• **Integer Division (`/`)** discards the fractional part 14.<br>• **Modulo (`%`)** returns the remainder (e.g., `15 % 4 = 3`) 15.                                                                    |
| **Increment/Decrement**       | Differentiate between prefix and postfix 16:<br><br>• **Prefix (`++a`)**: **First** operation (add 1), **then** use the new value (Pre-operation, then use) 17.<br>• **Postfix (`a++`)**: **First** use the current value, **then** operation (add 1) (Use, then Post-add) 18.             |
| **Assignment Operators**      | Know simple assignment (`=`) and compound assignment (e.g., `+=`, `-=`) as a shorthand for self-updating variables (e.g., `a += b` is equivalent to `a = a + b`) 19.                                                                                                                       |
| **Relational Operators**      | Know the operators: `>`, `>=`, `<`, `<=`, `==` (Equal to), `!=` (Not equal to) 20.<br><br>• **Result Logic**: Returns a Boolean value (1 for true, 0 for false) 21. In C, **any non-zero value is considered True**, and **zero is considered False** 22.                                  |

## 4.2 C Language Loops and Functions

| **Concept**      | **Key Points for Exam**                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`for` Loop**   | Memorize the syntax and the **five-step execution flow** 23:<br><br>1. Initialization (Once) → 2. Check Condition → 3. Execute Loop Body → 4. Execute Update → 5. Go to Step 2.                                                                                                                                                                                                                   |
| **`while` Loop** | Understand that the loop body repeats **as long as the condition is true** 24. An infinite loop is often written as `while(1)` 25.                                                                                                                                                                                                                                                                |
| **Functions**    | • **Purpose**: Decompose complex programs into reusable modules 26.<br>• **Components**: Return type (`void` for no return), Function name, Parameter list (for data passing), and Function body 27.<br>• **Function Body Rule**: All variable declarations **must** be placed before any execution statements 28.<br>• **`main()` Function**: The required entry point for program execution 29. |

## 4.3 51 Microcontroller Common Delay Methods

| **Concept**              | **Key Points for Exam**                                                                                                                                                                                                                                                                                                                                                                    |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Non-Precise Delay**    | **Method**: Using `for`/`while` empty loops (`for (i=0; i<N; i++);`) 30. **Disadvantage**: It is simple but **not precise** 31.                                                                                                                                                                                                                                                            |
| **Precise Delay**        | **Best Method**: Using **Timers/Counters** (dedicated hardware) 32.<br><br>• Another method: The `_nop_()` function (one machine cycle delay) 33.                                                                                                                                                                                                                                          |
| **Human Eye Phenomenon** | When the LED flashing frequency exceeds about 50Hz (i.e., the delay is too short), the LED appears to be **constantly ON** due to the persistence of vision 34.                                                                                                                                                                                                                            |
| **Keil Debugging**       | Be familiar with using the Keil simulator to measure delay time (execution time) by:<br><br>1. Setting breakpoints before and after the delay code 35.<br>2. Recording the time difference using the `sec` counter 36.<br>3. Note: If you cannot set a breakpoint, it is likely due to the compiler's default **code optimization** being enabled (set optimization level to 0 to fix) 37. |

### `_nop_`

The `_nop_()` function (or often `__nop()`, `__NOP()`, or similar variations) is a **compiler-specific intrinsic function** primarily used in **embedded C programming** for microcontrollers. It generates a single **No Operation (NOP)** assembly instruction, which causes the CPU to pause for exactly one clock cycle.

The exact function name and required header file depend on your **compiler** and **target microcontroller architecture**.

#### Example Code (Keil C51 Compiler)

A very common use case is with the Keil C51 compiler for the **8051 family of microcontrollers**.

```c
// Example using _nop_() for a very short delay (e.g., in an 8051 microcontroller)

#include <reg51.h>    // Standard header for 8051 registers
#include   // **Required** header for _nop_() intrinsic

void main(void) {
    // Initialize an output port/pin
    // P1_0 = 0; // Assuming P1.0 is an output pin

    while (1) {
        // Toggle the pin to create a square wave
        // P1_0 = 1;
        
        // Insert NOPs for a specific, very short delay
        // Each _nop_() typically takes 1 machine cycle
        _nop_();
        _nop_();
        _nop_();
        // ... add more _nop_() calls as needed for the desired delay

        // P1_0 = 0;

        // Insert NOPs for a short delay
        _nop_();
        _nop_();
        // ...
    }
}
```

---

#### Alternative/General Use (Other Compilers)

For **ARM Cortex-M** microcontrollers (like those used with compilers like GCC, Keil ARM, or IAR), the intrinsic is often `__NOP()`, and it's included via the **CMSIS** (Cortex Microcontroller Software Interface Standard) headers.

```c
// Example for ARM Cortex-M microcontrollers (using CMSIS)

#include "core_cm3.h" // Example CMSIS header for a Cortex-M3 (or similar)

void very_short_delay(void) {
    // Insert a single NOP instruction
    __NOP();
    
    // You can also loop for a slightly longer, but still precise, delay
    for (int i = 0; i < 10; i++) {
        __NOP();
    }
}
```

---

#### When is `_nop_()` Used?

The `_nop_()` function is generally used for two main purposes in embedded programming:

1. **Tiny, Predictable Delays:** To introduce a known, minimal delay (often just one clock cycle) when interacting with external hardware (like I/O ports or bus signals) that requires a specific timing or setup/hold time between operations.
2. **Scheduling Barriers/Debug Breakpoints:** To prevent the compiler's optimizer from removing or reordering a critical sequence of instructions, or to provide a specific, non-optimizable line of code where you can confidently set a **hardware breakpoint** during debugging.

## 4.4 Running Light Program

| **Concept**                  | **Key Points for Exam**                                                                                                                                                                                                                                                                                                         |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Running Light**            | The effect of 8 LEDs lighting up sequentially 38.                                                                                                                                                                                                                                                                               |
| **P0 Port Control**          | On the example board, the P0 port (P0.0 to P0.7) controls the 8 LEDs 39. **Crucial Logic**: For the LED circuit used in the slides, a logic level of **0 lights the LED ON**, and a logic level of **1 turns the LED OFF** (Active Low) 40.                                                                                     |
| **Efficient Implementation** | Use a combination of bitwise operators with the P0 port 41: `P0 = ~(0x01 << cnt);` 42.<br><br>• **Left Shift (`<<`)**: Moves the low (0) bit (which turns the LED ON) from P0.0 to P0.7 43.<br>• **Bitwise NOT (`~`)**: Flips the bits. This is necessary to ensure only the desired LED is 0 (ON) and the rest are 1 (OFF) 44. |
