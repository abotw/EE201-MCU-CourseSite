---
title: Ch07
layout: page
parent: Notes
---

# Chapter 7: Advanced Variables and Dot Matrix LED
{:.no_toc}

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

## 7.1 Variable Scope and Storage Class

| **Variable Type**         | **Position**                                    | **Scope**                                     | **Storage Location**                     | **Lifetime / Key Feature**                                                                                |
| ------------------------- | ----------------------------------------------- | --------------------------------------------- | ---------------------------------------- | --------------------------------------------------------------------------------------------------------- |
| **Global Variable**       | Declared outside all functions 1.               | Effective throughout the entire program 2.    | Global Data Area/Static Variable Area 3. | Occupies memory permanently until the program ends 4.                                                     |
| **Local Variable**        | Declared inside a function or as a parameter 5. | Only effective within the current function 6. | Stack (栈区) 7.                            | Created when the function is called, destroyed when it ends 8.                                            |
| **Static Local Variable** | Local variable with `static` keyword 9.         | Limited to the current function 10.           | Static Variable Area 11.                 | Initialized only once when the program starts 12. It retains its value across multiple function calls 13. |

**Global Variable Disadvantages:** They reduce code independence, make code hard to reuse and understand, and waste memory 14. Using **static local variables** (e.g., for loop indices like `i` and counters like `cnt` in interrupt service routines) is recommended for state-holding variables as it is safer and limits visibility 15.

## 7.2 Introduction to LED Dot Matrix

- **Structure:** An 8x8 dot matrix contains 64 LEDs 16.
- **Core Principle:** **Row and Column Scanning Method (行列扫描法)** 17.
- **Lighting an LED (Common Anode):** To light an LED, the corresponding row's anode must be set to **High Level (Selection)**, and the corresponding column's cathode must be set to **Low Level (Data)** 18.
- **Hardware Control:**
    - **Row Control:** Often handled by a **74HC138 decoder** connected to the microcontroller's I/O pins (e.g., `ADDR0`-`ADDR2`) 19.
    - **Column Control:** Handled directly by a microcontroller port (e.g., **P0 port**) which provides 8 bits of data to control all LEDs in the currently selected row 20.

## 7.3 Dot Matrix Graphical Display

- **Image Data (字模数据):** Graphic data (image or character) is first converted into hexadecimal byte codes (字模数据) using software 21.
- **Data Inversion:** Since the hardware is typically common anode (LED bright = 0, LED off = 1), the automatically generated data (which often defaults to Black=1, White=0) must be **Black/White Inverted (黑白反显)** to match the hardware requirements 22.
- **Display Method:** The image is displayed using **dynamic scanning** via a Timer 0 interrupt 23. The interrupt service routine cycles through the rows, outputting the corresponding byte data from the image's data array (`image[]`) to the column control port (e.g., P0) 24.
- **`code` Keyword:** In C51, `unsigned char code image[]` is used to store the large image data in **Program Memory (ROM/Flash)**, saving valuable **Data Memory (RAM)** 25.

## 7.4 & 7.5 Dot Matrix Animation Display

- **Animation Principle:** Utilizes **persistence of vision (视觉暂留)** by rapidly switching between a sequence of static frames (pictures) 26.
- **Frame Switching (Software Timer):** A small hardware timer interrupt (e.g., 1ms) is used to implement a **software timer (`tmr`)** that counts a longer time interval (e.g., 250ms) 27. When the time is up, an **image index (`index`)** is incremented to load the data for the next frame 28.
- **Data Structure for Horizontal Animation:** **Two-dimensional arrays** (`unsigned char code image[frames][8]`) are essential for storing multi-frame animations. The first dimension is the frame number, and the second dimension is the 8 bytes of row data for that frame 29.
- **Display Logic (2D Array):** The dynamic scan uses the expression `P0 = image[index][i]` where `index` selects the current animation frame, and `i` selects the current row within that frame 30.

---

## Exam Points for Final Exam

### I. Variable Concepts (Definitions and Comparisons)

- **Define and differentiate** between **Global Variable**, **Local Variable**, and **Static Local Variable** 31.
- **Know the scope and lifetime** for each type 32.
- **Identify the storage location** for each: Local on **Stack**, Static/Global in **Static Data Area** 33.
- **Explain the key feature of a static local variable:** It is initialized only once and retains its value between function calls 34.
- **List and explain the disadvantages of using Global Variables** (e.g., code safety, reusability, memory waste) 35.

### II. LED Dot Matrix (Principle and Hardware)

- **Know the core method** for displaying on a dot matrix: **Row and Column Scanning (行列扫描法)** 36.
- **Describe the conditions to light a single LED** in a common anode dot matrix (Row anode $\rightarrow$ High, Column Cathode $\rightarrow$ Low) 37.
- **Explain the role of the 74HC138 decoder** (Row selection/control) and the **P0 port** (Column data/control) in the hardware connection 38.
- **Calculate the number of LEDs** in a given matrix size (e.g., 8x8 = 64 LEDs) 39.

### III. Data and Code Concepts

- **Explain the meaning of "Black/White Inversion" (黑白反显)** in dot matrix data preparation and why it is necessary (to match the hardware's bright=0/off=1 logic) 40.
- **Know the function of the `code` keyword** in C51: It stores data in Program Memory (ROM) to save Data Memory (RAM) 41.
- **Understand the concept and memory layout of a Two-Dimensional Array** (`unsigned char A[2][3]`) and how it is used to store multi-frame animation data 42.

### IV. Programming Application (Timer Interrupt)

- **Explain the necessity of dynamic scanning** (using Timer Interrupt) for displaying static images and animations (due to persistence of vision and multiplexing) 43.
- **Identify the key static variables** used in the Timer 0 Interrupt Service Routine (`i` for dynamic scan index, `cnt` or `tmr` for software timing/frame switching) 44.
- **Explain how a software timer is implemented** using a hardware timer interrupt (e.g., a 1ms interrupt accumulating into a `tmr` counter to trigger an event, like frame change, every 250ms) 45.
